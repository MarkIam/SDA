{% extends "base.html"%}

{%block content%}
<div class="row">
    <!-- <div class="col-md-10 col-sm-12">
        <table class="table table-hover" >
            <thead>
                <tr>
                    <th> id</th>
                    <th> Фамилия </th>
                    <th> Имя </th>
                    <th> Почта </th>
                </tr>
            </thead>
            {% for skydiver in skydivers_list%}
            <tr> 
                <td> {{skydiver.id}} </td>
                <td> <a href="/skydiver/{{skydiver.id}}">{{skydiver.last_name}}</a></td>
                <td> {{skydiver.first_name}} </td>
                <td> {{skydiver.email }} </td>
            </tr>
            {%endfor%}
        </table >
    </div> -->
    <!-- <form action="" method="POST">
        <div class="mb-2">
            <label for="skydiverSelect" class="form-label">Клиент</label>
            <select id="skydiverSelect" class="form-select">
                {% for skydiver in skydivers_list%}
                <option value={{skydiver.id}}>{{skydiver.last_name}} {{skydiver.first_name}} </option>
                {%endfor%}
            </select>
        </div>
        <div class="mb-2">
            <label for="requestDate" class="form-label">Дата прыжка</label>
            <input id="requestDate" type="date" />
        </div>
    </form> -->
    <div class="col-3" id="liftsColumn">
        <h3>Дата</h3><input type='date' id='liftsDate' onchange='searchLifts();'>
        <div id="liftsArea"></div>
    </div>
    <div class="col-9" id="requestsArea">
    </div>
</div>
<script type="text/javascript">

    async function searchRequests(){
        let response = await fetch('http://127.0.0.1:8000/manifest/request/json')
        let data  = await response.json()

        let  ar = document.getElementById('requestsArea')
        ar.innerHTML='<h3>Заявки</h3><div class="accordion" id="accordionRequests">'
        let accordEl = document.getElementById('accordionRequests')
        let old_discipine = '-'
        let current_discipine = '-'
        let accordeonItem = undefined
        let accordeonBody = undefined

        for(let el of data){
            current_discipine = el.discipline_name
            if (current_discipine != old_discipine){
                accordeonItem = document.createElement('div')
                accordeonItem.className='accordion-item'
                accordeonItem.innerHTML = 
                    `<h3 class="accordion-header" id="heading` + el.discipline_short_name + `">
                        <button class="accordion-button` + (old_discipine == '-' ? '' : ' collapsed') + `" type="button" data-bs-toggle="collapse" data-bs-target="#collapse` + el.discipline_short_name + 
                        `" aria-expanded="` + (old_discipine == '-' ? 'true' : 'false') + `" aria-controls="collapse` + el.discipline_short_name + `">
                            ` + current_discipine + `
                        </button>
                    </h3>
                    <div id="collapse`+ el.discipline_short_name +`" class="accordion-collapse collapse` + (old_discipine == '-' ? ' show' : '') + `" aria-labelledby="heading` + el.discipline_short_name + `" data-bs-parent="#accordionRequests">
                        <div class="accordion-body">
                            <ul id="list-group-` + el.discipline_short_name + `" class="list-group">
                            </ul>
                        </div>
                    </div>`
                accordEl.appendChild(accordeonItem)
                accordeonBody = accordeonItem.getElementsByClassName('list-group')[0]

                old_discipine = current_discipine
            }
            skydiverElement = document.createElement('li')
            skydiverElement.id = 'req_' + el.id
            skydiverElement.className = 'list-group-item'
            skydiverElement.innerHTML= '<button class="btn btn-primary" onclick="BindRequestToLift(this, true)">&lt;</button>'+
                                        '<div>' + el.skydiver_name + ', ' + el.height + ' м</div><div>' + el.creationStamp + '</div>'
            
            accordeonBody.appendChild(skydiverElement)
        }
            
        return false
    }

    async function searchLifts(){
        let response = await fetch('http://127.0.0.1:8000/manifest/lift/json?pDay=' + document.getElementById('liftsDate').value)
        let data  = await response.json()

        let  ar = document.getElementById('liftsArea')
        ar.innerHTML=`<h3>Подъемы</h3><div class="accordion" id="liftsGroup">`
        let parent = document.getElementById('liftsGroup')

        let isFirst = true
        for(let lift of data){
            liftElement = document.createElement('div')
            liftElement.className='accordion-item'
            liftElement.id = 'lift_' + lift.id
            liftElement.innerHTML = `<h3 class="accordion-header" id="heading` + lift.plane_reg_number + `_` + lift.ord_number + `">
                        <button class="accordion-button` + (isFirst ? '' : ' collapsed') + `" type="button" data-bs-toggle="collapse" data-bs-target="#collapse` + lift.plane_reg_number + `_` + lift.ord_number + 
                        `" aria-expanded="` + (isFirst ? 'true' : 'false') + `" aria-controls="collapse` + + lift.plane_reg_number + `_` + lift.ord_number + `">
                            `+ lift.ord_number + ', ' + lift.plane_reg_number + `
                        </button>
                    </h3>
                    <div id="collapse` + lift.plane_reg_number + `_` + lift.ord_number + `" class="accordion-collapse collapse` + (isFirst ? ' show' : '') + `" 
                        aria-labelledby="heading` + lift.plane_reg_number + `_` + lift.ord_number + `" data-bs-parent="#liftsGroup">
                        <div class="accordion-body">
                            <ul id="list-group-` + lift.plane_reg_number + `_` + lift.ord_number + `" class="list-group">
                            </ul>
                        </div>
                    </div>`
            parent.appendChild(liftElement)
            accordeonBody = liftElement.getElementsByClassName('list-group')[0]

            for(let req of lift.requests){
                requestElement = document.createElement('li')
                requestElement.id = 'req_' + req.id
                requestElement.className = 'list-group-item'
                requestElement.innerHTML= '<div>' + req.name + '</div>'+
                                          '<button class="btn btn-primary"onclick="BindRequestToLift(this, false)">&gt;</button>'
                
                accordeonBody.appendChild(requestElement)
            }
            isFirst = false
        }
        if (data.length == 0)
            parent.innerHTML = 'Подъемы отсутствуют'

        return false
    }
    
    async function BindRequestToLift(elem, pIsBind)
    {
        let selectedLift = document.querySelectorAll('#liftsGroup .accordion-item button[aria-expanded="true"]')
        if (selectedLift.length == 0){
            alert('Не выбран подъем для включения заявки.');
            return;
        }
        let liftId = document.querySelectorAll('#liftsGroup .accordion-item button[aria-expanded="true"]')[0].parentElement.parentElement.id.substr(5)
        
        let requestId = elem.parentElement.id.substr(4)

        let response = await fetch('http://127.0.0.1:8000/bind_request_to_lift/', {
                                        method: 'POST',
                                        headers: {
                                            'X-CSRFToken': "{{ csrf_token }}",
                                            'Content-Type': 'application/json;charset=utf-8'
                                        },
                                            body: JSON.stringify({request_id: requestId,
                                                                  lift_id: liftId,
                                                                  is_bind: pIsBind })
                                        });

        let status = await response.json()
        if (status.status=='OK'){
            searchLifts();
            searchRequests();
        }
        else
            alert('При выполнении операции произошла ошибка.')
    }

    let liftsDateCtrl = document.getElementById('liftsDate')
    
    let today = new Date();
    let mm = today.getMonth() + 1;
    let dd = today.getDate();

    liftsDateCtrl.value = today.getFullYear() + '-' + (mm>9 ? '' : '0') + mm + '-' + (dd>9 ? '' : '0') + dd;
    searchLifts();

    searchRequests();
</script>

{%endblock%}